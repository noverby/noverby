default: run

build:
    nixos-rebuild build-image --image-variant qemu --flake .#nixos-rs
    qemu-img convert -p -f qcow2 -O raw result/nixos-image-*-x86_64-linux.qcow2 nixos-rs.raw

run:
    #!/usr/bin/env bash
    KERNEL=$(nix build --print-out-paths .#nixosConfigurations.nixos-rs.config.system.build.kernel)/bzImage
    INITRD=$(nix build --print-out-paths .#nixosConfigurations.nixos-rs.config.system.build.initialRamdisk)/initrd
    cloud-hypervisor \
      --kernel "$KERNEL" \
      --initramfs "$INITRD" \
      --disk path=nixos-rs.raw \
      --cmdline "console=ttyS0 root=LABEL=nixos init=/nix/var/nix/profiles/system/init" \
      --cpus boot=2 \
      --memory size=4096M \
      --serial tty \
      --console off

# Run automated boot test with serial output capture (120s timeout)
test:
    ./test-boot.sh --verbose

# Run boot test with a custom timeout (in seconds)
test-timeout seconds="30": build
    ./test-boot.sh --verbose --timeout {{ seconds }}

# Run boot test and save the boot log to a file
test-log path="boot.log":
    ./test-boot.sh --verbose --log {{ path }}

# Run boot test quietly (no streaming output, just pass/fail)
test-quiet:
    ./test-boot.sh

# Boot test then keep the VM running for interactive debugging
test-keep:
    ./test-boot.sh --verbose --keep

# Rebuild disk image and re-run boot test
test-rebuild: build
    ./test-boot.sh --verbose

clean:
    rm -f result
    rm -f nixos-rs.raw

tree:
    nix-tree --derivation .#nixosConfigurations.nixos-rs.config.system.build.toplevel
