build:
  mkdir -p build
  mojo build --emit llvm --target-features "none" -o build/out.ll src/main.mojo
  sed -i '/call void @llvm\.lifetime\.\(start\|end\)/d' build/out.ll
  llc --mtriple=wasm64-wasi -filetype=obj build/out.ll
  wasm-ld --no-entry --export-all --allow-undefined -mwasm64 --initial-memory=16777216 -o build/out.wasm build/out.o

test: build
  deno run --allow-read test/run.ts

mojo-test:
  mojo test -I src test-mojo/

wasm-test: build
  uv run --with wasmtime --with pytest pytest test-wasm/ -v

test-all: mojo-test test wasm-test

serve: build
  @echo "Open http://localhost:4507/examples/counter/"
  deno run --allow-net --allow-read jsr:@std/http/file-server
